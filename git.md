<!-- Based off the best readme template from https://github.com/othneildrew/Best-README-Template -->
<!-- Improved compatibility of back to top link: See: https://github.com/othneildrew/Best-README-Template/pull/73 -->
<a name="readme-top"></a>

# Git and GitHub

This document attempts to summarize how we use git in our development cycle; and some of the processes / automations we have on GitHub.

<details>
	<summary>Table of Contents</summary>
	<ol>
		<li>
			<a href="#branching">Branching</a>
			<ul>
				<li><a href="#gitflow-workflow">Gitflow Workflow</a></li>
				<li><a href="#naming-convention">Naming Convention</a></li>
				<li><a href="#manual-deletion">Manual Deletion</a></li>
			</ul>
		</li>
		<li>
			<a href="#merging">Merging</a>
			<ul>
				<li><a href="#rebasing">Rebasing</a></li>
				<li><a href="#squash-merging">Squash Merging</a></li>
				<li><a href="#commit-merging">Commit Merging</a></li>
			</ul>
		</li>
		<li>
			<a href="#automations">Automations</a>
			<ul>
				<li><a href="#circleci-integration">CircleCI Integration</a></li>
				<li><a href="#helm-integration">Helm Integration</a></li>
				<li><a href="#thanos-api">Thanos API</a></li>
				<li><a href="#pre-commit-hooks">Pre Commit Hooks</a></li>
			</ul>
		</li>
	</ol>
</details>

## Branching

### Gitflow Workflow

We adopt the[Gitflow Workflow](https://www.atlassian.com/git/tutorials/comparing-workflows/gitflow-workflow). As the concept is well explained by the link, please read through for an explanation of what it is, and how to use it.

Slight variations exists in our [naming convention](#naming-convention).

Another variation is also the merge strategies used for the different branches.

For merges into `develop`, we should be using [Squash Merging](#squash-merging).

For merges into `master`, either from `hotfix` or `release` branches, we should be using [Commit Merging](#commit-merging).

<p align="right">(<a href="#readme-top">back to top</a>)</p>

### Naming Convention

For all branches (except `feature/` branches), we need to append the suffix `_XXX-D` where `X` is any alphabet `a-z` (lower or uppercase) and `D` is any digits `0-9`.

This is a legacy "issue", where we used to have multiple services that performs the pipeline, and the suffix would help to determine which service was used. But we've since reduced to 1.

For release branches, instead of the example in Gitflow Workflow of `release/0.1.0` we use `release/v0.1.0_XXX-D`, with the notable addition of the character `v`.

As for the numbering of releases, we follow the [Semantic Versioning](https://semver.org/)

<p align="right">(<a href="#readme-top">back to top</a>)</p>

### Manual Deletion

Branches do not auto-delete on merging on Github. The reason for this is that we have an automation that checks on merges into `master` to see if there's a need to down-merge into `develop`. See [thanos-api](#thanos-api)

Therefore, on merge, please wait awhile to see if the automation creates a linked PR, if not manually delete the branch.

<p align="right">(<a href="#readme-top">back to top</a>)</p>

## Merging strategy

### Rebasing

Atlassian again has a good article on what rebasing is, and how it's different from merging: [Merging vs Rebasing](https://www.atlassian.com/git/tutorials/merging-vs-rebasing)

Prior to merging, please rebase the branch above the target. For `feature` branch, it should be rebased onto `develop`, and as the article mentions, interactive rebasing can be used to clean up the local commits, but this is not necessary due to [Squash Merging](#squash-merging). 

The rebasing ensures that there will be no merge conflicts.

<p align="right">(<a href="#readme-top">back to top</a>)</p>

### Squash Merging

GitHub has a short section on [Squash merging](https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/configuring-pull-request-merges/about-merge-methods-on-github#squashing-your-merge-commits).

We use squash merging when merging into `develop` as this makes the history of `develop` branch easier to follow, making `git blame` cleaner and the automatic message generated by GitHub on merging will also make it easier to figure out which PR was associated with the commit. It also gives developers the freedom to commit in whichever way they prefer during development of their feature. 

<p align="right">(<a href="#readme-top">back to top</a>)</p>

### Commit Merging

The same GitHub page also has a short section on [Commit Merging](https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/configuring-pull-request-merges/about-merge-methods-on-github#squashing-your-merge-commits:~:text=When%20you%20click%20the%20default%20Merge%20pull%20request%20option%20on%20a%20pull%20request%20on%20GitHub.com%2C%20all%20commits%20from%20the%20feature%20branch%20are%20added%20to%20the%20base%20branch%20in%20a%20merge%20commit.).

We use commit merging when merging into `master` from `release` or `hotfix` branches.
This helps to see which PRs / features are included into each release, and also helps to create a Release on github with easy to follow changelog.
Reversing the release of a particular feature will also be quick by cherry picking.

<p align="right">(<a href="#readme-top">back to top</a>)</p>

## Automations

### CircleCI Integration

We use CircleCI to do our CI/CD.

Configuration is set up in each repository under a `.circleci` folder.
This is generally managed by the SRE team, but for new repositories, it's easier to start by copying the whole folder from other repositories like atlas.

When making changes in `.circleci`, the changes should be isolated into a PR and the SRE team should review and approve.

Automated tests are also ran in `.circleci`.
Current configuration is that it will only run when PRs have been opened for the branch.

<p align="right">(<a href="#readme-top">back to top</a>)</p>

### Helm Integration

We also use Helm for CD. Helm is used to set up the k8s settings and also the environment variables.

Configuration is set up in each repository under a `.pipeline` folder.
This is generally managed by the SRE team, but for new repositories, it's easier to start by copying the whole folder from other repositories like atlas.

When making changes in `.pipeline`, the changes should be isolated into a PR and the SRE team should review and approve.

<p align="right">(<a href="#readme-top">back to top</a>)</p>

### Thanos API

This is useful for when we have `hotfix` branches, or when our `release` branches have bugfix commits. On merge into `master`, the automation will automatically create a new PR to merge into `develop` if it detects changes. After merging the new PR, it will also delete the branch.

The problem comes when there's no need for the automation, for example if it's a regular `feature` branch or a `release` branch without any changes. As the automation doesn't take any action, it would not delete the branch after merge. This is a feature in the works for Thanos API.

It is also not possible to enable auto-deletion on merge on Github settings, as this immediately deletes the branch on clicking merge, and our automation will fail.

<p align="right">(<a href="#readme-top">back to top</a>)</p>

### Pre Commit Hooks

We set up pre-commit hooks to perform things like linting and auto formatting.

This is set up using the python package `pre-commit` in most repository.
Configurations are in `.pre-commit-config.yaml` and should also be copy-able for new repositories.

<p align="right">(<a href="#readme-top">back to top</a>)</p>
